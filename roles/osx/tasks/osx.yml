---

- name: Install Claude Code CLI
  ansible.builtin.shell: curl -fsSL https://claude.ai/install.sh | bash
  changed_when: false
  tags: [osx]

- name: Update Claude Code CLI
  ansible.builtin.command: "{{ ansible_env.HOME }}/.local/bin/claude update"
  changed_when: false
  tags: [osx, update]

- name: Create Claude configuration directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.claude"
    state: directory
    mode: '0755'
  tags: [osx]

- name: Symlink Claude environment documentation
  ansible.builtin.file:
    src: "{{ ansible_env.PWD }}/roles/osx/files/CLAUDE.md"
    dest: "{{ ansible_env.HOME }}/.claude/CLAUDE.md"
    state: link
  tags: [osx]

- name: Symlink Claude settings.json
  ansible.builtin.file:
    src: "{{ ansible_env.PWD }}/roles/osx/files/claude/settings.json"
    dest: "{{ ansible_env.HOME }}/.claude/settings.json"
    state: link
  tags: [osx]

- name: Create Cursor rules directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.cursor/rules"
    state: directory
    mode: '0755'
  tags: [osx]

- name: Symlink Cursor MDC rules file
  ansible.builtin.file:
    src: "{{ ansible_env.PWD }}/roles/osx/files/environment.mdc"
    dest: "{{ ansible_env.HOME }}/.cursor/rules/environment.mdc"
    state: link
  tags: [osx]

- name: Showing Library folder
  ansible.builtin.command: chflags nohidden ~/Library
  changed_when: false
  tags: [osx]

- name: Applying OSX defaults
  community.general.osx_defaults:
    domain: "{{ item.domain }}"
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  with_items: "{{ osx_defaults }}"
  tags: [osx]

# Idempotency is broken :(
- name: Applying lists OSX defaults
  community.general.osx_defaults:
    domain: "{{ item.domain }}"
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  with_items: "{{ osx_list_defaults }}"
  changed_when: false
  tags: [osx]
